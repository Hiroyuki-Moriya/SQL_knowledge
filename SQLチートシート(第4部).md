# SQLチートシート (第4部　/　全4部)

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
## 参考文献

 スッキリわかるSQL入門 第２版
 dokoQL デスクトップ版
  https://dokoQL/d/
    ID：SUKKIRI=2800YEN
    PW：（何も入力しない）

 Microsoft SQL Transact-SQL リファレンス (データベース エンジン)
  （Docs＞SQL＞リファレンス＞Transact-SQL (T-SQL) リファレンス）
  https://docs.microsoft.com/ja-jp/sql/t-sql/language-reference?view=sql-server-ver15

 Microsoft SQL データベース関数
  （Docs＞SQL＞リファレンス＞Transact-SQL (T-SQL) リファレンス＞関数）
  https://docs.microsoft.com/ja-jp/sql/t-sql/functions/functions?view=sql-server-ver15

 逆引きSQL構文集
  http://www.sql-reference.com/index.html#string

/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
## テーブルの設計

### データベース構築のINPUTとOUTPUT
	INPUT:要件の一覧表（お客様からインタビューしたもの）
	OUTPUT:一連のDDL文（データ定義言語。
	　　　　　　　　　　テーブルなどの作成や削除、各種設定などの命令(CREATE,ALTER,DROP,TRUNCATE)）

	概念設計：要件に登場する情報を使って、管理すべき情報を整理する。
	　　　　　情報間の関連や関係も整理する。データベースやシステムは考えない。
	論理設計：概念設計で明らかにした管理すべき情報を使って、RDBを使う前提で構造を整理する。
	　　　　　テーブルと列がわかれば十分。
	物理設計：特定のDBMS製品(例えばSQL Server)を使う前提に立ち、論理設計で明らかになった各テーブルを具体化する。
	　　　　　すべてのテーブルのすべての列について、型、インデックス、制約、デフォルト値など、テーブル作成に必要なすべての要素を確定する。

### 概念設計
	エンティティ(entity)…情報のかたまり。「テーブル」のようなもの。
	　　　　　　　　　　　帳簿のように形のあるものだけでなく、入出金行為のように形のないものもエンティティになる。
	属性(attribute)…テーブルの「列」のようなもの。
	関連(relationship)…テーブル間の関連

	ER図(ERD:entity-relationship diagram)…実体関連図。エンティティ、属性、関連を俯瞰してみることができる図。
	　　　　　　　　　　　　　　　　　　記法としてIE(Information Engineering)がよく使われる。
	　　　　　　　　　　　　　　　　　　[ER図の Crow's Foot 記法 (IE 記法)](https://knooto.info/erd-crows-foot/)
	　　　　　　　　　　　　　　　　　　[ER図の書き方５ステップ](https://it-koala.com/entity-relationship-diagram-1897)

	多重度（カーディナリティ）…エンティティ同士の数量的な関係。1:1、0or1:1、1:多、1:多(0以上)、1:多(1以上)

#### (参考)ER図のツールを探した
	[ER図をいい感じに作れそうなモデリングツールを探してみた](http://bashalog.c-brains.jp/18/02/14-144444.php)
	●A5:SQL Mk-2　SQLを実行したり、テーブルを編集するほかに、SQLの実行計画を取得したり、ER図を作成したりすることが出来ます。
	・MySQL WorkBench 高機能なMySQLのデータモデル開発用アプリケーション。ER図からDDLへのエクスポートが可能、DBとの接続、SQL実行も可能。
	・ERDPlus ER図を作れる、シンプルな機能と操作性のWebアプリ。Beta版ですがExportSQLからDDL生成もできるようです。
	・WWW SQL Designer hサーバーに設置可能なPHP製ツールで、ブログにも多く取り上げられています。 SQL出力可能。
	・LucidChart Webアプリ。DFDなどのモデリングツールです。 ER図からDDLを作成する機能はありません。
	・draw.io。クラウドストレージと密に融合しているWebアプリ。Google DriveやOne Drive上にファイルを保存できます。 Databaseのテンプレート内にER図があります。描画のみ。
	・Edraw MAX。MS Office製品に近いUIを持つアプリ。グラフィカルなプレゼン資料作成向き。エンティティの描画は可能ながら、属性やデータ型の追加機能などはありません。

### 論理設計
	論理設計の目的は、概念上のエンティティをリレーショナルデータベースモデルで扱いやすい形のテーブルに変形することにある。

	論理設計の流れ
	・多対多の関係は、中間テーブルを使って、２つ以上の１対多の関係に変換する。
	・キーを整理する。主キーが備えるべき３つの特性を持っていること。
		非NULL性：必ず何らかの値を持っている
		一意性：他と重複しない
		不変性：一度決定されたら値が変化することがない（主キーは、一貫して同じ１行を指し示す）
	・正規化(normalization)する。矛盾したデータを格納できないように、テーブルを複数に分割していく作業。
		『１つの事実は１箇所に(one-fact in one-place)』…整合性が崩れにくい優れたテーブル設計の原則

### 正規化の手順
	正規形(normalized form)…正規化によってテーブルが手説に分割された状態
	正規化の流れ…手元にあるエンティティ構造（テーブル構）を、非正規形から第３正規形まで順次変形していく。

#### 第一正規形への変形…繰り返し列の排除
	テーブルのすべての行のすべての列に１つずつ値が入っているべきである。
	よって、繰り返しの列やセル結合（同じ値が列や行に現れる）があってはならない。
	非正規形を第一正規形に変形するステップ
	①繰り返しの列の部分を別の表に切り出す（費目ID列と費目名列など）
	②切り出したテーブルの仮の主キーを決める
	③主キー列をコピーして複合主キーを構成する

#### 関数従属性
	関数従属性とは「ある列Ａの値が決まれば、おのずと列Ｂの値も決まる」という関係。
	このとき「列Ｂは列Ａに関数従属している」という。　イメージ的には　Fx(A)=B
	例えば、入出金行為ＩＤがわかればその日付が確定できるとすると、日付は入出金行為ＩＤに関数従属しているといえる。

	すべての非キー列は、主キーにきれいに関数従属しているべきである。

#### 第二正規形への変形…部分関数従属の排除
	主キーに対する「きたない関数従属（部分関数従属）」の排除が目的。
	複合主キーを持つテーブルの場合、非キー列は、複合主キーの全体に関数従属するべきである。
	よって、「複合主キーの一部に対してのみ関数従属する列」が含まれてはならない
	①複合主キーの一部に関数従属する列を切り出す。
	②部分関数従属先だった列をコピーする

#### 第三正規形への変形…間接的な関数従属（推移関数従属）の排除
	テーブルの非キー列は、主キーに直接、関数従属すべきである。
	よって、「主キーに関数従属する列に、さらに関数従属する列」は存在してはならない。
	①間接的に主キーに関数従属する列を切り出す
	②直接関数従属先だった列をコピーする



### 物理設計
	①最終的なテーブル名、列名（物理名）を決定する。
		物理名(physical name)…データベース内にテーブルが作られる際のテーブル名や列名
		論理名(logical name)…論理設計までの段階で利用してきた名前
		※SPROでの命名規約
		　テーブル名：英字名称の接尾辞に"_t"を付与する。
		　View：接尾辞に"_v"を付与する。
		　マスタ："m_○○○_t"とする。
		　SQLコマンド：sql_[英字]
	②列の型を決定する。
	③制約、デフォルト値を決定する。
	④インデックスを決定する。
	⑤その他（ビュー作成、性能のための巨大テーブル分割や非正規化）
		※正規化すると多数のテーブルをSQL上で結合することになり、処理性能が向上することもあるが、
		　データの整合性が崩れやすくなる。
		　
### 正規化されたデータの利用
	管理に適した形と、利用に適した形はことなる
		管理するときは…データは複数のテーブルに分割してあるほうがよい。
		利用するときは…データは１つのテーブルに結合してあるほうがよい。


/* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -  */
## TIPS
### テーブルの作成、バックアップ用にテーブルコピー、リストア

	データ削除や更新をする前の状態にロールバックできるようにすることを含めたテーブル作成方法と
	それを活用したバックアップテーブル作成、およびデータリストア方法

	１．テーブル作成
		EXCELに定義書とデータを作成する
		SSMS＞データベースを右クリック>タスク>データのインポート
		　参照　第一部 ＞ データインポート方法 ＞ Excel から SQL Server または Azure SQL Database にデータをインポートする
		マッピングでテーブル名と型の定義を修正し、インポートする

	２．テーブル生成スクリプトを作成する
		SSMSのテーブル＞デザインで、主キーとCHECK制約を入力
		タスク＞スクリプト生成
				・スクリプトファイル保存する
				・UNICODEを選択
		ファイル名 SQLquery[識別名]-script.sqlで保存する

	３．バックアップ用テーブルの作成
		SSMSで新規SQLを作成し、２で保存した SQLquery[識別名]-script.sql のSQL文をコピペする。
		ファイル名をバックアップ用に書き換える
			事例　ファイルが [テーブル名]_t (※ _t はサフィックス）の場合は
			　　　サフックスをキーワードにして [テーブル名]BKP_tに置換する。
		SQLを実行する。
		SQLはファイル名 SQLquery[識別名]BKP-script.sqlで保存する

	４．データのリストア
		SSMS＞データベースを右クリック>タスク>データのインポート
		　参照　第一部 ＞ データインポート方法 ＞ Excel から SQL Server または Azure SQL Database にデータをインポートする
		リストア先のテーブル名を修正し、インポートする
		※前の３で型や主キーや制約ができているので、前の１のような型の修正は不要

### テスト用環境で使用するためデータベースを他の場所へコピーする

	(移出元)(ZK0AAA85:SQL Server 2019)
	SSMSのdokoQLを右クリック＞タスク＞バックアップ
	コピーのみのバックアップにチェックを入れる
		標準のバックアップ先はココ↓
			C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Backup
			dokoQL.bak

  (移出先)SSMSが同じバージョンのとき
  dokoQL.bakをココ↓に入れる
    C:\Program Files\Microsoft SQL Server\MSSQL12.SQLEXPRESS\MSSQL\Backup
	SSMSのdokoQLを右クリック＞タスク＞復元＞データベース
	デバイスのラジオボタンを選択
  バー右の･･･をクリックして、「バックアップデバイスの選択」ウィンドゥを開く
  「追加」ボタンを押して、dokoQL.bakを選択する

	 Microsoft SQL Transact-SQL リファレンス
		(Docs ＞ SQL ＞ ビジネス継続性 ＞ バックアップと復元 ＞ 概念 ＞ バックアップ ＞ コピーのみのバックアップ）
		https://docs.microsoft.com/ja-jp/sql/relational-databases/backup-restore/copy-only-backups-sql-server?view=sql-server-ver15


  (移出先)SSMSが異なるバージョンのとき(ZK0AAA85:SQL Server 2014))
  直接復元ができないので、テーブルごとに作成スクリプトを保存し、それをリストア先で実行する。
  ①移出先のSQL Server Management Studioで、
  　各テーブルごとに右クリックからテーブルをスクリプト化 → 新規作成 → ファイル を選択する。
  　その後、適当なファイル名を付けて保存する。
  ②移出先で、保存したファイルを開き、Product_Mngのデータベースを選択して実行する。
  　テーブル作成に成功すれば「コマンドは正常に完了しました。」と表示される。
  作成できたテーブルを確認すると、正しく構造が正しく移し込まれている。

	 Qiita
		(SQL Serverのバージョンが異なるため復元に失敗する）
		https://qiita.com/RollSystems/items/b2c79a62c7e5604f216d




### 不等号の読み方
	「<」は左辺が右辺より小さいことを示す。
	「>」は左辺が右辺より大きいことを示す。
	使用例
	3 > 2 （3は2より大きい／3大なり2） -- ★「より小さい」「より大きい」はその数を含めない表現
	2 < 3 （2は3より小さい／2小なり3） -- ★必ず左辺を主語としていることに注意
	プログラミングでは「LT (less than)」「GT (greater than)」と呼ぶこともあるが、ほとんどの言語で、不等号は < と > で表される。

	「≦」「≤」「⩽」（いずれでも意味は同じ）は左辺が右辺より小さいか等しい（a < b または a = b）ことを示す。
	「≧」「≥」「⩾」は左辺が右辺より大きいか等しいことを示す。
	A ≦ B (AはB以下／A小なりイコールB) -- ★必ず左辺を主語としていることに注意
	A ≧ B (AはB以上／A大なりイコールB)
	プログラミングでは「LE (less than or equal to)」「GE (greater than or equal to)」と呼ぶこともあるが、
	ほとんどの言語で、等号付き不等号は <= と >= で表される。

	[参考:Wikipedia](https://ja.wikipedia.org/wiki/%E4%B8%8D%E7%AD%89%E5%8F%B7)
